"use strict";var express=require("express"),session=require("express-session"),mongoose=require("mongoose"),bodyParser=require("body-parser"),methodOverride=require("method-override"),routes=require("./lib/controllers/main"),_=require("lodash"),Collection=require("./lib/models/Collection"),Strategy=require("./lib/strategy"),Options=require("./lib/options"),admin=express();admin.use(session({resave:!1,secret:"Siracha!",saveUninitialized:!0})),admin.set("view engine","jade"),admin.set("views",__dirname+"/lib/views"),admin.use(bodyParser.urlencoded({extended:!1})),admin.use(methodOverride(function(e,o){if(e.body&&"object"==typeof e.body&&"_method"in e.body){var s=e.body._method;return delete e.body._method,s}})),admin.use("/static",express.static(__dirname+"/lib/static")),admin.use("/components",express.static(__dirname+"/components")),module.exports=function(e){var o,s,n,i,t=Options(e=e||{});return o=t.models.length>0?t.models.map(function(e){return mongoose.models[e]}):mongoose.models,s=_.mapValues(_.mapKeys(o,function(e){return e.collection.name}),function(e){return e.modelName}),n=_.mapValues(o,function(e){return Collection(e,t)}),admin.locals._mongooseModels=o,admin.locals.collectionNames=s,admin.locals.collections=n,admin.use(function(e,o,s){var n=admin.mountpath;admin.locals.appPath=n,s()}),admin.use(function(e,o,s){e.session.message=e.session.message||{error:[],success:[],info:[]},admin.locals.message=e.session.message,s()}),i=new Strategy(t),admin.use(i.middleware.bind(i)),admin.get("/",routes.main),admin.post("/login",i.login.bind(i)),admin.post("/logout",i.logout),admin.get("/:collection",routes.collection),admin.post("/:collection/suggest",routes.suggest),admin.all("/:collection/new",routes.newDoc),admin.all("/:collection/:doc",routes.doc),admin};